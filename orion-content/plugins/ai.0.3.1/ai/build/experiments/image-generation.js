(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var n in a)e.o(a,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:a[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React;var a=e.n(t);const n=window.wp.element,i=window.wp.hooks,r=window.wp.i18n,o=window.wp.components,s=window.wp.data,l=window.wp.editor,c=window.wp.notices,d=window.wp.apiFetch;var u=e.n(d);const g=window.wp.url;let p=!1;const m=()=>{p||(console.warn("[AI Experiments] wp.abilities.executeAbility is unavailable. Falling back to REST."),p=!0)};async function w(e,t,a){var n;const i=null!==(r=window?.wp?.abilities)&&void 0!==r?r:null;var r;if("function"==typeof i?.executeAbility)try{return await i.executeAbility(e,null!=t?t:null)}catch(e){if(!(e=>{if(!e||"object"!=typeof e)return!1;const t="message"in e&&"string"==typeof e.message?e.message:"";return"ability_not_found"===("code"in e&&"string"==typeof e.code?e.code:"")||t.includes("Ability not found")})(e))throw e;m()}else m();const o=null!==(n=a?.method)&&void 0!==n?n:"POST",s=await u()(((e,t,a)=>{const n=null!=t?t:null;return"GET"===a||"DELETE"===a?{path:null===n?`/wp-abilities/v1/abilities/${e}/run`:(0,g.addQueryArgs)(`/wp-abilities/v1/abilities/${e}/run`,{input:n}),method:a}:{path:`/wp-abilities/v1/abilities/${e}/run`,method:"POST",data:{input:n}}})(e,t,o));return s}const f=window.wp.blockEditor,_=window.wp.blocks,h="[[IMAGE_GOES_HERE]]";const{aiImageGenerationData:b}=window,y=window.ReactJSXRuntime;function x(){const{editPost:e}=(0,s.useDispatch)(l.store),t=(0,s.select)(l.store).getEditedPostContent(),a=(0,s.select)(l.store).getCurrentPostId(),i=(0,s.select)(l.store).getEditedPostAttribute("featured_media"),[d,u]=(0,n.useState)(!1),[g,p]=(0,n.useState)(null),m=i?(0,r.__)("Generate new featured image","ai"):(0,r.__)("Generate featured image","ai");return(0,y.jsx)("div",{className:"ai-featured-image editor-post-featured-image",children:(0,y.jsxs)("div",{className:"ai-featured-image__container editor-post-featured-image__container",children:[(0,y.jsx)(o.Button,{__next40pxDefaultSize:!0,className:"ai-generate-featured-image editor-post-featured-image__toggle",onClick:async()=>{u(!0),p(null),(0,s.dispatch)(c.store).removeNotice("ai_image_generation_error");try{const n=await async function(e,t,a){const n=a?.onProgress;let i,o;try{i=await async function(e){const t={post_id:e,fields:["title","type"]};return await w("ai/get-post-details",t).then(e=>{if(e&&"object"==typeof e)return e;throw new Error("Invalid response from get context")}).catch(e=>{throw new Error(e.message)})}(e)}catch(e){throw new Error(`Failed to get post context: ${e.message||e}`)}try{n?.((0,r.__)("Generating image prompt","ai")),o=await async function(e,t){const a={content:e,context:t};return await w("ai/image-prompt-generation",a).then(e=>e&&"string"==typeof e?e:"").catch(e=>{throw new Error(e.message)})}(t,(s=i,Object.entries(s).filter(([,e])=>null!=e&&""!==e).map(([e,t])=>`${e.replace(/_/g," ").replace(/(?:^|\s)\S/g,e=>e.toUpperCase())}: ${t}`).join("\n")))}catch(e){throw new Error(`Failed to generate prompt: ${e.message||e}`)}var s;return n?.((0,r.__)("Generating image","ai")),w("ai/image-generation",{prompt:o}).then(e=>{if(e&&"object"==typeof e){const t=e;return t.prompt=o,t}throw new Error("Invalid response from generate image")}).catch(e=>{throw new Error(e.message)})}(a,t,{onProgress:p}),i=await async function({image:e,prompt:t},a){const n=a?.onProgress,i={data:e.data,mime_type:"image/png",description:(0,r.sprintf)(/* translators: 1: Provider name, 2: Model name, 3: Date, 4: Prompt */ /* translators: 1: Provider name, 2: Model name, 3: Date, 4: Prompt */
(0,r.__)("Generated by %1$s using %2$s on %3$s. Prompt: %4$s","ai"),e.provider_metadata.name,e.model_metadata.name,(new Date).toLocaleDateString(),t),meta:[{key:"ai_generated",value:"1"}]};if(i.alt_text=t,b?.altTextEnabled)try{n?.((0,r.__)("Generating alt text","ai")),i.alt_text=await async function(e,t,a,n){const i={};if(e)i.attachment_id=e;else{if(!t)throw new Error((0,r.__)("No image available to generate alt text for.","ai"));i.image_url=t}if(a){const e=void 0!==n?function(e,t){const a=(0,s.select)(f.store).getBlock(t);if(!a)return e;const n=(0,_.serialize)(a);return n&&e.includes(n)?e.replace(n,h):e}(a,n):a;i.context=`What follows is the full article content, where the image has been replaced with the placeholder ${h}. Use the surrounding text to understand the purpose, subject, and relevance of the image within the article. Be sure to describe only information not already conveyed in nearby text. CONTENT: \n\n${e}`}const o=await w("ai/alt-text-generation",i);if(o&&"object"==typeof o&&"alt_text"in o)return o.alt_text;throw new Error((0,r.__)("Failed to generate alt text.","ai"))}(void 0,`data:image/png;base64,${e.data}`)}catch(e){i.alt_text=t}return i.title=function(e,t=80){if(e.length<=t)return e;const a=e.substring(0,t),n=a.lastIndexOf(" ");return n>.5*t?a.substring(0,n):a}(i.alt_text),n?.((0,r.__)("Importing image","ai")),await w("ai/image-import",i).then(e=>{if(e&&"object"==typeof e&&"image"in e)return e.image;throw new Error("Invalid response from image import")}).catch(e=>{throw new Error(e.message)})}(n,{onProgress:p});e({featured_media:i.id})}catch(e){(0,s.dispatch)(c.store).createErrorNotice(e,{id:"ai_image_generation_error",isDismissible:!0})}finally{u(!1),p(null)}},disabled:d,isBusy:d,children:m}),g&&(0,y.jsxs)("div",{className:"ai-featured-image__progress",role:"status","aria-live":"polite",style:{color:"#757575",marginTop:"10px"},children:[g,(0,y.jsx)(o.Spinner,{style:{marginLeft:"5px",marginTop:"0",position:"inherit",verticalAlign:"text-top"}})]})]})})}const E=window.wp.coreData;function v({label:e}){const t=(0,s.select)(l.store).getEditedPostAttribute("featured_media"),[a,i]=(0,n.useState)(null),r=(0,s.useSelect)(e=>t?e(E.store).getEntityRecord("postType","attachment",t):null,[t]);return(0,n.useEffect)(()=>{r?i(r):t||i("")},[r,t]),(0,y.jsx)(y.Fragment,{children:a&&1===a?.meta?.ai_generated&&(0,y.jsx)("div",{className:"ai-label",children:(0,y.jsx)("span",{className:"ai-label__text",style:{color:"#757575"},children:e})})})}const{aiImageGenerationData:j}=window;(0,i.addFilter)("editor.PostFeaturedImage","ai/image-generation",function(e){return j.enabled?function(t){return(0,n.createElement)(a().Fragment,{},(0,y.jsx)(x,{}),(0,n.createElement)(e,t),(0,y.jsx)(v,{label:(0,r.__)("AI Generated Featured Image","ai")}))}:e})})();